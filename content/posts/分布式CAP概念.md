---
title: 分布式CAP概念
date: 2018-08-28T10:22:37+08:00
draft: false
toc: true
comments: true
aliases:
  - /detail/167
  - /detail/167/
tags:
  - 分布式
---

> 参考：
> [博客1](http://www.ruanyifeng.com/blog/2018/07/cap.html)

### 1、CAP定理概述

分布式系统有三个指标

* (C) Consistency
* (A) Availability
* (P) Partition tolerance

这3个指标不可能同时达到，最多只可能两个同时达到

### 2、Consistency一致性

一致性指当发生写操作成功后，整个系统的状态保持一致，也就是立即能读到写入的修改。

一致性按照强弱分为下列几个级别

* 强一致性：指系统中的某个数据被成功更新后，后续任何对该数据的读取操作都将得到更新后的值
* 弱一致性：弱一致性是相对于强一致性而言，它不保证总能得到最新的值；
* 最终一致性：是弱一致性的特殊形式，即保证在没有新的更新的条件下，经过一段“不一致时间窗口”，最终所有的访问都是最后更新的值。最常见的是DNS服务，更新域名指向的机器后，多级缓存要等到expiration time的时候才会更新，但是随着时间的推移，最终数据会趋于一致。

一般的要求C的系统，要求是强一致性

#### （1）一致性的实现方案

* 两阶段提交协议
* 三阶段提交协议

### 3、Availability可用性

Availability 中文叫做"可用性"，意思是只要收到用户的请求，服务器就必须在一定时间内给出回应。

用户可以选择向 G1 或 G2 发起读操作。不管是哪台服务器，只要收到请求，就必须告诉用户，到底是 v0 还是 v1，否则就不满足可用性。

### 4、Partition tolerance分区容忍度

大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。

比如：G1 和 G2 是两台跨区的服务器。G1 向 G2 发送一条消息，G2 可能无法收到。系统设计的时候，必须考虑到这种情况。

一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们，剩下的 C 和 A 无法同时做到。

### 5、Consistency 和 Availability 的矛盾

一致性和可用性，为什么不可能同时成立？答案很简单，因为可能通信失败（即出现分区容错）。

如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，G2 不能读写，没有可用性不。

如果保证 G2 的可用性，那么势必不能锁定 G2，所以一致性不成立。

综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。

简单的说，当发生分区时系统可用（满足P），必须保证数据多备份

* 如果满足一致性（C），必须保证所有数据全部写入所有备份后才能返回成功（或者使用一些一致性协议），当在此期间发生错误，为了达到一致性，必须等待系统恢复到一致性状态才能返回，在恢复过程中系统不可用（A）
* 如果满足可用性（A），必然不能锁定系统，，那么不能保证数据在多个备份的一致性（C）

### 6、常见分布式系统的分类

#### （1）CP的系统

要求保证强一致性的系统

如果一个分布式系统不要求强的可用性，即容许系统停机或者长时间无响应的话，就可以在CAP三者中保障CP而舍弃A。

一个保证了CP而一个舍弃了A的分布式系统，一旦发生网络故障或者消息丢失等情况，就要牺牲用户的体验，等待所有数据全部一致了之后再让用户访问系统。

* 分布式事务系统
* 很多分布式数据库，如 Redis、HBase、TiDB
* Zookeeper

#### （2）AP的系统

要求高可用

要高可用并允许分区，则需放弃一致性。一旦网络问题发生，节点之间可能会失去联系。为了保证高可用，需要在用户访问时可以马上得到返回，则每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。

* 业务系统来说，比如淘宝的购物，12306的买票。都是在可用性和一致性之间舍弃了一致性而选择可用性。

### 7、BASE理论

BASE理论是对CAP理论的延伸，核心思想是即使无法做到强一致性（Strong Consistency，CAP的一致性就是强一致性），但应用可以采用适合的方式达到最终一致性（Eventual Consitency）。

* 基本可用（Basically Available）

基本可用是指分布式系统在出现故障的时候，允许损失部分可用性，即保证核心可用。
电商大促时，为了应对访问量激增，部分用户可能会被引导到降级页面，服务层也可能只提供降级服务。这就是损失部分可用性的体现。

* 软状态（ Soft State）

软状态是指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布式存储中一般一份数据至少会有三个副本，允许不同节点间副本同步的延时就是软状态的体现。mysql replication的异步复制也是一种体现。

* 最终一致性（ Eventual Consistency）

最终一致性是指系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况。
